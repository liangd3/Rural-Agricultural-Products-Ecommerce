{% if session['user_type'] == 'manager' %}
{% extends 'manager/manager_layout.html' %} 
{% elif session['user_type'] == 'admin' %}
{% extends 'admin/admin_layout.html' %} 
{% endif %}

{% block title %} Moa Creek Rural Supplies Manager {% endblock %}
{% block content %}

<main id="main" class="main">

    <div class="pagetitle">
      <h1>Promotions</h1>
      <nav>
        <ol class="breadcrumb">
          {% if session['user_type'] == 'admin' %}
          <li class="breadcrumb-item"><a href="{{ url_for('admin.admin_dashboard') }}">Home</a></li>
          {% elif session['user_type'] == 'manager' %}
         <li class="breadcrumb-item"><a href="{{ url_for('manager.manager_dashboard') }}">Home</a></li>
         
         {% endif %}
          <li class="breadcrumb-item active">Promotions</li>
        </ol>
      </nav>
    </div><!-- End Page Title -->

    <section class="section">
      <div class="row">
        <div class="col-lg-12">

          <div class="card">
            <div class="card-body">
              <div class="row">
                <div class="mt-4 mb-3 col">
                  <a href="{{url_for('manager.promotion_new')}}" class="btn btn-sm btn-danger">New Promotion</a>
                </div>
                <div class="mt-4 mb-3 col">
                    <form method="post" action="{{url_for('manager.promotion_list_sorted')}}">
                      <label>Filter: 
                      <select name="type" id="sortType" onchange="if (value!='') {this.form.submit();}">
                        <option value="" selected>Select a type</option>
                        <option value="category">Categories</option>
                        <option value="subcategory">Subcategories</option>
                        <option value="product">Products</option>
                      </select>
                      <select name="status" id="sortStatus" onchange="if (value!='') {this.form.submit();}">
                        <option value="" selected>Select a status</option>
                        <option value="active">Active</option>
                        <option value="soon">Comming Soon</option>
                        <option value="inactive">Inactive</option>
                        <option value="expired">Expired</option>
                      </select>
                      {% if type or status %}
                      <a id="resetFilter" href="{{url_for('manager.manager_promotion_management')}}" class="btn btn-sm btn-secondary">Reset Filter</a>
                      {% endif %}
    
                      </label>
                      
                    </form>
                </div>
              </div>

              <!-- Table with stripped rows -->
              <table class="table datatable">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Description</th>
                    <th>Type</th>
                    <th>Discount</th>
                    <th data-type="datetime" data-format="DD/MM/YYY HH:MM">Start Date</th>
                    <th data-type="datetime" data-format="DD/MM/YYY HH:MM">End Date</th>
                    <th>Status</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                  {% for promotion in promotions %}
                  <tr>
                    
                    <td>{{promotion.promotion_id}}</td>
                    <td>{{promotion.promotion_name}}</td>
                    <td>{{promotion.promotion_description}}</td>
                    <td style="text-transform: capitalize;">{{promotion.promotion_type}}</td>
                    <td>
                      {% if promotion.special_condition  %}
                        {{promotion.special_condition}}
                      {% else %}
                        {% set discount = promotion.discount_rate|float * 100 %}
                        {{discount|int}}% off
                      {% endif %}
                    </td>
                    <td><span style="font-size: 0px">{{promotion.start_date}}</span>{{promotion.start_date|nzdatetime}}</td>
                    <td><span style="font-size: 0px">{{promotion.end_date}}</span>{{promotion.end_date|nzdatetime}}</td>
                    <td>{% if promotion.status == "Active" %}
                      <span class="badge bg-danger text-white">
                    {% elif promotion.status == "Coming Soon" %}
                      <span class="badge bg-success text-white">
                    {% elif promotion.status == "Expired" %}
                      <span class="badge bg-secondary text-white">
                    {% else %}
                      <span class="badge bg-info text-white">
                    {% endif %}
                    {{promotion.status}}
                    </td>
                    <td>
                      <a href="{{url_for('manager.promotion_detail', id = promotion.promotion_id)}}" class="btn btn-primary">Edit</a>
                    </td>
                  </tr>
                  {% endfor %}
                  {% if not promotions%}
                  <tr>
                    <td>No promotion found</td>
                  </tr>
                  {% endif %}
                </tbody>
              </table>
              <!-- End Table with stripped rows -->

            </div>
          </div>

        </div>
      </div>
    </section>

</main><!-- End #main -->

<meta id="sortDataFromServer" data-type="{{type}}" data-status="{{status}}">

<script>
  const sort_type = $('#sortDataFromServer').data('type');
  const sort_status = $('#sortDataFromServer').data('status');

  document.addEventListener("DOMContentLoaded", function() { 
    if (sort_type != '') {
      $('#sortType').val(sort_type);
    };
    if (sort_status != '') {
      $('#sortStatus').val(sort_status);
    };
  });
  
</script>

{% endblock %}