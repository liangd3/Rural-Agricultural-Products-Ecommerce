{% extends 'admin/admin_layout.html' %} 
{% block title %} Moa Creek Rural Supplies Admin {% endblock %}


{% block content %}

<main id="main" class="main">

    <div class="pagetitle">
      <h1>Subcategories Management</h1>
      <nav>
        <ol class="breadcrumb">
          {% set path = session.user_type ~ "." ~ session.user_type ~ "_dashboard" %}
          <li class="breadcrumb-item"><a href="{{ url_for(path) }}">Home</a></li>
          <li class="breadcrumb-item active">Subcategories Management</li>
        </ol>
      </nav>
    </div><!-- End Page Title -->

    <section class="section">
      <div class="row">
        <div class="col-lg-12">
          <div class="card">
              <div class="card-body">
                  <br>
                    <!-- Button -->
                    <div class="d-flex justify-content-between mb-3">
                        <button type="button" id="newButton" class="btn btn-primary btn-sm" onclick="toggleNewRow()">Add New</button>
                        <button type="button" id="cancelButton" class="btn btn-secondary mr-2" onclick="window.location.href='/admin/subcategoriesManagement'" style="display: none;">Cancel</button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover datatable" id="myTable">
                            <thead>
                            <tr>
                                <th>Category</th>
                                <th>Subcategory</th>
                                <th>Actions</th>
                            </tr>
                            </thead>
                            <tbody>
                                <tr id="newRow" style="display: none;">
                                    <td>
                                        <select name="new_category_id" class="form-control" id="new_category_id" required>
                                            <option selected disabled>Choose from below</option>
                                            {% for category in categories %}
                                              <option value="{{category.category_id}}" data-bs-toggle="tab" data-bs-target="#{{category.category_id}}">{{category.category_name}}</option>                          
                                            {% endfor %}
                                        </select>
                                    </td>
                                    <td>
                                        <input type="text" id="new_subcategory_name" name="new_subcategory_name" required>
                                    </td>
                                    <td>
                                        <button type="button" class="btn btn-primary" onclick="validateAndSubmitNewSubcategoryName()">Done</button>
                                    </td>
                                </tr>
                                {% for c_n_s in categories_and_subcategories %}
                                <tr>
                                    <td>{{c_n_s.category_name}}</td>
                                    <td> 
                                        <input type="text" id="subcategory_name_{{ c_n_s.subcategory_id }}" name="subcategory_name_{{ c_n_s.subcategory_id }}" value="{{ c_n_s.subcategory_name }}" disabled>
                                    </td>
                                    <!-- Actions -->
                                    <td>
                                        <input type="hidden" name="subcategory_id" value="{{ c_n_s.subcategory_id }}">
                                        <button type="button" class="btn btn-primary" data-id="{{ c_n_s.subcategory_id }}" data-action="edit" onclick="toggleEdit('{{ c_n_s.subcategory_id }}')">Edit</button>
                                        <button type="button" class="btn btn-primary" style="display: none;" data-id="{{ c_n_s.subcategory_id }}" data-action="done" id="doneButton_{{ c_n_s.subcategory_id }}" onclick="validateAndSubmitSubcategoryName('{{ c_n_s.subcategory_id }}')">Done</button>
                                    </td>                    
                                </tr>                         
                                {% endfor %}
                              
                               
                            </tbody>
                        </table>
                    </div>
                  </div>
              </div>
          </div>
      </div>
    </section>
</main><!-- End #main -->
{% endblock %}


{% block js %}
<script>

// toggle edit button
function toggleEdit(subcategoryId) {
    var input = document.getElementById('subcategory_name_' + subcategoryId);
    var inputs = document.querySelectorAll('#subcategory_name_' + subcategoryId);
    var editButton = document.querySelector('button[data-id="' + subcategoryId + '"][data-action="edit"]');
    var doneButton = document.querySelector('button[data-id="' + subcategoryId + '"][data-action="done"]'); 
    var cancelButton = document.getElementById('cancelButton');    

    if (editButton.style.display !== 'none') {
        editButton.style.display = 'none';
        doneButton.style.display = 'inline-block';
        cancelButton.style.display = 'inline-block';
    } else {
        editButton.style.display = 'inline-block';
        doneButton.style.display = 'none';
        cancelButton.style.display = 'none';
    }
    inputs.forEach(function(input) {
        input.disabled = !input.disabled;
    });
  }

  // toggle a new row when adding a new record
  function toggleNewRow() {
    var newRow = document.getElementById('newRow');
    var newButton = document.getElementById('newButton');
    var cancelButton = document.getElementById('cancelButton');    
    
    newRow.style.display = newRow.style.display === 'none' ? 'table-row' : 'none';

    if (newButton.style.display !== 'none') {
        newButton.style.display = 'none';
        cancelButton.style.display = 'inline-block';
    } else {
        newButton.style.display = 'inline-block';
        cancelButton.style.display = 'none';
    }

    if (newButton.textContent === 'New') {
        newButton.textContent = 'Undo';
    } else {
        newButton.textContent = 'New';
    }
  }

  // input validation for a new input record
  function validateAndSubmitNewSubcategoryName() {

    var newCategoryID = document.getElementById('new_category_id').value.trim();
    var newSubcategoryName = document.getElementById('new_subcategory_name').value.trim();

    if (!newCategoryID || !newSubcategoryName) {
        alert('Please complete the fields');
        return;
    }

    // Check for special characters in SUbcategory Name
    var categoryNameTest = /^[a-zA-Z0-9 ]+$/;
    if (!categoryNameTest.test(newSubcategoryName)) {
        alert('Subcategory name cannot contain special characters!');
        return;
    }

    var existingRows = document.querySelectorAll('#myTable tbody tr');
    for (var i = 0; i < existingRows.length; i++) {
        if (existingRows[i].id === 'newRow') continue; // Skip the new row

        var existingCategoryName = existingRows[i].querySelector('input[name^="subcategory_name_"]').value.trim();

        // Check if subcategory name match existing
        if (newSubcategoryName === existingCategoryName) {
                alert('This subcategory name already exists.');
                return;
        }
    }
    // Create a hidden form
    var form = document.createElement('form');
    form.style.display = 'none'; // Hide the form

    // Set form attributes
    form.method = 'POST';
    form.action = '{{ url_for('admin.admin_subcategoriesManagement') }}';

  // Create form fields and append them to the form
  function createAndAppendInput(name, value) {
        var input = document.createElement('input');
        input.type = 'hidden';
        input.name = name;
        input.value = value;
        form.appendChild(input);
  }

    createAndAppendInput('new_category_id', newCategoryID);
    createAndAppendInput('new_subcategory_name', newSubcategoryName);

    // Append the form to the document body
    document.body.appendChild(form);
    // Submit the form
    form.submit();
  }

    // input validation for a editted input record
  function validateAndSubmitSubcategoryName(subcategoryId) {
    var SubcategoryName = document.getElementById('subcategory_name_' + subcategoryId).value.trim();

    if (!SubcategoryName) {
        alert('Please complete the field');
        return;
    }

    // Check for special characters in Subcategory Name
    var categoryNameTest = /^[a-zA-Z0-9 ]+$/;
    if (!categoryNameTest.test(SubcategoryName)) {
        alert('Subcategory name cannot contain special characters!');
        return;
    }

    var existingRows = document.querySelectorAll('#myTable tbody tr');
    for (var i = 0; i < existingRows.length; i++) {
        if (existingRows[i].id === 'newRow') continue; // Skip the new row
        var existingCategoryId = existingRows[i].querySelector('input[name="subcategory_id"]').value;
        if (existingCategoryId === subcategoryId) continue; // Skip the current edited row

    var existingSubcategoryName = existingRows[i].querySelector('input[name^="subcategory_name_"]').value.trim();

    // Check if subcategory name match existing
    if (SubcategoryName === existingSubcategoryName) {
        alert('This subcategory name already exists.');
        return;
    }}
    

    // Create a hidden form
    var form = document.createElement('form');
    form.style.display = 'none'; // Hide the form

    // Set form attributes
    form.method = 'POST';
    form.action = '{{ url_for('admin.admin_subcategoriesManagement') }}';

    // Create form fields and append them to the form
    function createAndAppendInput(name, value) {
        var input = document.createElement('input');
        input.type = 'hidden';
        input.name = name;
        input.value = value;
        form.appendChild(input);
    }

    createAndAppendInput('subcategory_id', subcategoryId);
    createAndAppendInput('subcategory_name', SubcategoryName);

    // Append the form to the document body
    document.body.appendChild(form);  
    // Submit the form
    form.submit();
  } 
</script>
{% endblock %}